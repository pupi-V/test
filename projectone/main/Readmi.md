# master-slave ESP-IDF Project

## Описание

Этот проект реализует взаимодействие устройств ESP32 по UDP с использованием mDNS и веб-интерфейса.  
Конфигурация проекта задаётся через файл `config.json`, который компилируется в прошивку и используется при запуске.

---

## Формат файла конфигурации `config.json`

Файл должен находиться в папке `main` и содержать параметры в формате JSON:

```json
{
  "AP": "client",                // Режим работы: "client" (STA) или "point" (AP)
  "AP_login": "MyWiFi",          // Имя Wi-Fi сети (SSID) для подключения или создания точки доступа
  "AP_pass": "password123",      // Пароль Wi-Fi сети
  "slave_list": [                // список устройств группы
    "charger_90070.local",
    "charger_90074.local"
  ],
  "TP": "60",                   // Выделенная мощность кВт (total power)
  "SP": "16",                   // Максимальный ток станции А (single power)
  "MP": "6"                     // Минимальная мощность А (minimum power)
}
```

### Описание полей:

- **AP**  
  Режим работы устройства:  
  - `"client"` — подключение к существующей Wi-Fi сети (STA)
  - `"point"` — создание собственной точки доступа (AP)

- **AP_login**  
  Имя Wi-Fi сети (SSID) для подключения (в режиме client) или имя создаваемой точки доступа (в режиме point).

- **AP_pass**  
  Пароль Wi-Fi сети. Если оставить пустым, точка доступа будет открытой.

- **slave_list**  
  Список имён устройств (mDNS-имена, например, `"charger_90074.local"`), с которыми будет взаимодействовать мастер или слейв.  
  Максимум 16 устройств.

- **TP**  
  Общая мощность, подлежащая распределению, которую выделили на группу станций. Единица измерени - кВт.
  
- **SP**  
Максимальный ток, который ограничивает потребление одного зарядного порта, даже при условии доступности свободной мощности. Единица измерения - А.

- **MP**  
Минимальный ток, на котором будет работать зарядная станция при аварии в системе распределения мощности (фактически общая мощность делённая на количество станций в группе). Единица измерения - А.
---

## Пример использования

1. Отредактируйте `main/config.json` под вашу сеть и список устройств.
2. Соберите и прошейте проект.
3. После загрузки устройства автоматически прочитают конфигурацию и начнут работу в заданном режиме.

---

## Примечания

- Имя устройства (`device_name`) и его mDNS-имя должны совпадать с одним из элементов `slave_list`.
- Все устройства должны находиться в одной Wi-Fi сети для корректной работы mDNS и UDP.
- Для корректной работы веб-интерфейса и UDP-обмена используйте отдельные FreeRTOS задачи (реализовано в проекте).

## Описание логики взаимодействия мастер-слейв

После определения мастера в группе зарядных станций мастер запускает широковещательный пакет, который показывает что он занимает доменирующую позицию. Остальные станции запускают в ответ пакет приветствия. Мастер сравнивает список группы с полученными пакетами, если какая-либо станция не ответила, мастер посылает повторный запрос адресно к этой станции. Если после двух адресных запросов ответа нет, станция слейва считается отключенной и вычеркивается из списка группы. Слейвы в свою очередь запоминают адрес мастера. на запросы с другого адреса они не реагируют.
В случае, если в процессе работы мастер получил широковещательный пакет, что в сети появился новый мастер ему следует ответить адресным ответом, что мастер в сети уже есть, что принудительно преведет устройство в режим слейва, а мастер проверит список слейвов, и если этот слейв был исключен из списка, вернет его в список. Такая ситуация может произойти, когда одну из станций отключили или принудительно перезагрузили, в это время в сети выбрали нового мастера.
В случае, если в процессе работы мастер перестал опрашивать слейвов в течении 60 секунд в группе происходит процес выборов: вычеркивает старого мастера из списка группы и запускает процесс пересчета ранга по новому списку. После выбора мастер приветствует группу. Если этого не произошло в течении 30 секунд после перерасчета устройство с первым рангом вычёркивается из списка и производится новый перерасчет. Следует учесть и не допустить ситуацию, когда устройство попытается вычеркнуть само себя. Если устройство попыталось вычеркнуть себя из списка, приходим к выводу, что мы имеем проблемы с сетью и работаем на минимальной мощности (минимальная мощность указана в файле конфигурации).
В случае если новый мастер на совё приветствие группе получает ответ, что мастер уже есть в группе, он автоматически переходит в режим слейва.

## Формат сообщений UDP

### Пример запроса на получение текущих данных от мастера
```
90070MR90074N0028
```
### Описание полей

| Поле   | Длина в символах | Описание                       | Допустимые значения |
|--------|------------------|--------------------------------|---------------------|
| 90070  | 5                | Серийный номер мастера         | a-Z, 0-9            |
| MR     | 2                | master request (тип пакета)    | MR                  |
| 90074  | 5                | Серийный номер слейва          | a-Z, 0-9            |
| N0028  | 5                | Номер запроса                  | N0001–N9999         |

### Пример ответа на запрос с данными от слейва
```
90074SA90070N0028D0123456789ABCDEF
```
### Описание полей:

| Поле   | Длина в символах | Описание                                | Допустимые значения |
|--------|------------------|-----------------------------------------|---------------------|
| 90074  | 5                | Серийный номер подчиненного устройства  | a-Z, 0-9            |
| SA     | 2                | slave answer (request)                  |SA, SR               |
| 90070  | 5                | Серийный номер мастера                  | a-Z, 0-9            |
| N0028  | 5                | Номер запроса                           | N0001–N9999         |
| D      | 1                | Тип сообщения (data/set (config/reject))| D, SC, SR           |
| 01     | 2                | Статус устройства                       | 00–FF (hex)         |
| 23     | 2                | Текущее напряжение фаза A               | 00–FF (hex) 00-100 В|
| 45     | 2                | Текущее напряжение фаза B               | 00–FF (hex) 00-100 В|
| 67     | 2                | Текущее напряжение фаза C               | 00–FF (hex) 00-100 В|
| 89     | 2                | Текущий ток фаза A                      | 00–FF (hex) 00-0 А  |
| AB     | 2                | Текущий ток фаза B                      | 00–FF (hex) 00-0 А  |
| CD     | 2                | Текущий ток фаза C                      | 00–FF (hex) 00-0 А  |
| EF     | 2                | Текущая мощность                        | 00–FF (hex) 00-0 кВт|
| 01     | 2                | Разрешенная мощность                    | 00–FF (hex) 00-0 А  |

### Детализация полей:

- **Серийный номер подчиненного устройства**  
  Серийный номер устройства, которому был направлен запрос от мастера.

- **slave answer**  
  Тип пакета, свидетельствует о том, что это ответ на полученный запрос

- **Серийный номер мастера**  
  Серийный номер текущего мастера, фактически устройства от которого был получен запрос.

- **Номер запроса**  
  N - буквенный разделитель (от number), четыре цифры номер запроса, на который устройство отвечает

- **Тип сообщения**  
  В данном случае сообщение с данными(data)

#### Далее каждое поле представляет из себя байт

- **Статус устройства**  
  Передаётся текущий статус устройства

- **Текущее напряжение фаза A, Текущее напряжение фаза B, Текущее напряжение фаза C**  
  Напряжение по каждой из фаз на устройстве

- **Текущий ток фаза A, Текущий ток фаза B, Текущий ток фаза C**  
  Ток по каждой из фаз на устройстве

- **Текущая мощность**  
  Мощьность, передаваемая через устройство

- **Разрешенная мощьность**  
  Установленное значение максимально разрешенной мощности

---

### Пример запроса на установку параметров от мастера
```
90070MR90074N0028SP01
```
| Поле   | Длина в символах | Описание                                 | Допустимые значения         |
|--------|------------------|------------------------------------------|-----------------------------|
| 90070  | 5                | Серийный номер мастера                   | a-Z, 0-9                    |
| MR     | 2                | master request (тип пакета)              | MR                          |
| 90074  | 5                | Серийный номер слейва                    | a-Z, 0-9                    |
| N0028  | 5                | Номер запроса                            | N0001–N9999                 |
| S      | 1                | Тип команды (set)                        | S                           |
| P      | 1                | Разрешение на заряд (permit/forbid)      | P (permit), F (forbid)      |
| 01     | 2                | Установка значения текущая мощность      | 00–FF (hex), 00–255 А       |

- **Установка значения текущая мощность**  
  Если передаётся 00, значит текущее значение мощности менять не следует. Если передаётся значение ниже, чем минимальное (за исключением 00), или больше чем максимальное, то значение установлено не будет, в ответе вернется код ошибки в формате 0b11100000, где первые три бита - код ошибки от 0 до 7, остальные 5 бит это текущее значение тока.

### Пример ответа на запрос с данными от слейва
```
90074SA90070N0028С00
```

| Поле   | Длина в символах | Описание                                | Допустимые значения |
|--------|------------------|-----------------------------------------|---------------------|
| 90074  | 5                | Серийный номер подчиненного устройства  | a-Z, 0-9            |
| SA     | 2                | slave answer (тип пакета)               | SA                  |
| 90070  | 5                | Серийный номер мастера                  | a-Z, 0-9            |
| N0028  | 5                | Номер запроса                           | N0001–N9999         |
| C      | 1                | Статус установки значений config/reject | D, C, R             |
| 00     | 2                | Код ошибки                              | 00-FF               |

- **Статус установки значений: D, SC, SR**  
  Содержание этой строки зависит от запроса мастера. Если запросили данные, то после D будет кортеж из данных, если запрос был на установку параметров, то вернется статус установки параметров.

---

### Пример широковещательного приветствия мастера

```
90070MBFFFFFN0001
```

| Поле   | Длина в символах | Описание                                 | Допустимые значения         |
|--------|------------------|------------------------------------------|-----------------------------|
| 90070  | 5                | Серийный номер мастера                   | a-Z, 0-9                    |
| MB     | 2                | master broadcast (тип пакета)            | MB                          |
| FFFFF  | 5                | Широковещательный адрес (broadcast)      | FFFFF                       |
| N0001  | 5                | Номер сообщения                          | N0001–N9999                 |

- **MB** — тип пакета, обозначающий широковещательное приветствие мастера.
- **FFFFF** — специальное значение, обозначающее широковещательный адрес (все устройства группы).
- **Номер сообщения** — уникальный номер для идентификации пакета.

---

### Пример ответа "мастер уже есть" (старый мастер новому)

```
90074ME90070N0002
```

| Поле   | Длина в символах | Описание                                  | Допустимые значения         |
|--------|------------------|-------------------------------------------|-----------------------------|
| 90074  | 5                | Серийный номер текущего мастера           | a-Z, 0-9                    |
| ME     | 2                | master exists (тип пакета)                | ME                          |
| 90070  | 5                | Серийный номер нового мастера (ошибочного)| a-Z, 0-9                    |
| N0002  | 5                | Номер сообщения                           | N0001–N9999                 |

- **ME** — тип пакета, обозначающий, что мастер уже есть в сети.
- **Серийный номер нового мастера** — адресат сообщения (тот, кто ошибочно решил стать мастером).


