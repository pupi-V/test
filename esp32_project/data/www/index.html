<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32 –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ó–∞—Ä—è–¥–Ω—ã–º–∏ –°—Ç–∞–Ω—Ü–∏—è–º–∏</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: white;
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .header p {
      color: rgba(255,255,255,0.9);
      font-size: 1.1rem;
    }
    
    .status-bar {
      background: rgba(255,255,255,0.95);
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .controls {
      background: rgba(255,255,255,0.95);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .controls h2 {
      margin-bottom: 15px;
      color: #374151;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: #10b981;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-danger {
      background: #ef4444;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .stations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .station-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: all 0.3s;
      border-left: 4px solid #3b82f6;
    }
    
    .station-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.15);
    }
    
    .station-card.charging {
      border-left-color: #10b981;
    }
    
    .station-card.error {
      border-left-color: #ef4444;
    }
    
    .station-card.offline {
      border-left-color: #6b7280;
    }
    
    .station-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .station-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1f2937;
    }
    
    .station-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-available {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-charging {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .status-offline {
      background: #f3f4f6;
      color: #374151;
    }
    
    .station-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .info-label {
      color: #6b7280;
      font-size: 13px;
    }
    
    .info-value {
      font-weight: 500;
      color: #1f2937;
      font-size: 13px;
    }
    
    .power-bar {
      background: #f3f4f6;
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .power-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #3b82f6);
      transition: width 0.3s;
    }
    
    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 10px;
      border-radius: 6px;
      font-size: 13px;
      margin-top: 10px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 1.1rem;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      margin: 50px auto;
      padding: 20px;
      border-radius: 10px;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #374151;
    }
    
    .form-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    @media (max-width: 768px) {
      .stations-grid {
        grid-template-columns: 1fr;
      }
      
      .status-bar {
        flex-direction: column;
        gap: 10px;
      }
      
      .button-group {
        justify-content: center;
      }
      
      .header h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîå ESP32 –ó–∞—Ä—è–¥–Ω—ã–µ –°—Ç–∞–Ω—Ü–∏–∏</h1>
      <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—Ä—è–¥–Ω—ã–º–∏ —Å—Ç–∞–Ω—Ü–∏—è–º–∏ –¥–ª—è —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª–µ–π</p>
    </div>

    <div class="status-bar">
      <div class="status-item">
        <div class="status-dot"></div>
        <span>–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
      </div>
      <div class="status-item">
        <span>–°—Ç–∞–Ω—Ü–∏–π: <strong id="stationCount">0</strong></span>
      </div>
      <div class="status-item">
        <span>WebSocket: <strong id="wsStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</strong></span>
      </div>
      <div class="status-item">
        <span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: <strong id="lastUpdate">--</strong></span>
      </div>
    </div>

    <div class="controls">
      <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
      <div class="button-group">
        <button class="btn btn-success" onclick="addStation()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–Ω—Ü–∏—é</button>
        <button class="btn" onclick="refreshData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <button class="btn" onclick="exportData()">üìä –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
        <button class="btn btn-danger" onclick="emergencyStop()">üõë –ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞</button>
      </div>
    </div>

    <div id="loading" class="loading">
      –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π...
    </div>

    <div id="stationsGrid" class="stations-grid" style="display: none;">
      <!-- –°—Ç–∞–Ω—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞–Ω—Ü–∏–∏ -->
  <div id="stationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–Ω—Ü–∏—é</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <form id="stationForm">
        <div class="form-group">
          <label class="form-label">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
          <input type="text" class="form-input" id="displayName" required>
        </div>
        <div class="form-group">
          <label class="form-label">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∏–º—è</label>
          <input type="text" class="form-input" id="technicalName" required>
        </div>
        <div class="form-group">
          <label class="form-label">–¢–∏–ø —Å—Ç–∞–Ω—Ü–∏–∏</label>
          <select class="form-input" id="stationType" required>
            <option value="master">Master</option>
            <option value="slave">Slave</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å (–∫–í—Ç)</label>
          <input type="number" class="form-input" id="maxPower" min="0" step="0.1" required>
        </div>
        <div class="button-group">
          <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    let ws = null;
    let stations = [];
    let currentEditingId = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
      connectWebSocket();
      loadStations();
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞–Ω—Ü–∏–∏
      document.getElementById('stationForm').addEventListener('submit', handleStationSubmit);
    });

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = function() {
        document.getElementById('wsStatus').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
        document.getElementById('wsStatus').style.color = '#10b981';
      };
      
      ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.type === 'stationsUpdate') {
          stations = data.data;
          renderStations();
          updateLastUpdate();
        }
      };
      
      ws.onclose = function() {
        document.getElementById('wsStatus').textContent = '–û—Ç–∫–ª—é—á–µ–Ω';
        document.getElementById('wsStatus').style.color = '#ef4444';
        
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(connectWebSocket, 5000);
      };
      
      ws.onerror = function(error) {
        console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
        document.getElementById('wsStatus').textContent = '–û—à–∏–±–∫–∞';
        document.getElementById('wsStatus').style.color = '#ef4444';
      };
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π —á–µ—Ä–µ–∑ API
    async function loadStations() {
      try {
        const response = await fetch('/api/stations');
        if (response.ok) {
          stations = await response.json();
          renderStations();
          updateLastUpdate();
        } else {
          throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–Ω—Ü–∏–π:', error);
        document.getElementById('loading').innerHTML = 
          '<p style="color: #ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.</p>';
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    function renderStations() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('stationsGrid').style.display = 'grid';
      document.getElementById('stationCount').textContent = stations.length;
      
      const grid = document.getElementById('stationsGrid');
      grid.innerHTML = '';
      
      stations.forEach(station => {
        const card = createStationCard(station);
        grid.appendChild(card);
      });
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞–Ω—Ü–∏–∏
    function createStationCard(station) {
      const card = document.createElement('div');
      card.className = `station-card ${station.status}`;
      
      const statusMap = {
        'available': { class: 'status-available', text: '–î–æ—Å—Ç—É–ø–Ω–∞' },
        'charging': { class: 'status-charging', text: '–ó–∞—Ä—è–∂–∞–µ—Ç' },
        'error': { class: 'status-error', text: '–û—à–∏–±–∫–∞' },
        'offline': { class: 'status-offline', text: '–û—Ç–∫–ª—é—á–µ–Ω–∞' },
        'maintenance': { class: 'status-offline', text: '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ' }
      };
      
      const statusInfo = statusMap[station.status] || statusMap['offline'];
      const powerPercent = station.maxPower > 0 ? (station.currentPower / station.maxPower * 100) : 0;
      
      card.innerHTML = `
        <div class="station-header">
          <div class="station-name">${station.displayName}</div>
          <div class="station-status ${statusInfo.class}">${statusInfo.text}</div>
        </div>
        
        <div class="station-info">
          <div class="info-item">
            <span class="info-label">–¢–∏–ø:</span>
            <span class="info-value">${station.type === 'master' ? 'Master' : 'Slave'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">–ú–∞–∫—Å. –º–æ—â–Ω–æ—Å—Ç—å:</span>
            <span class="info-value">${station.maxPower} –∫–í—Ç</span>
          </div>
          <div class="info-item">
            <span class="info-label">–¢–µ–∫—É—â–∞—è –º–æ—â–Ω–æ—Å—Ç—å:</span>
            <span class="info-value">${station.currentPower} –∫–í—Ç</span>
          </div>
          <div class="info-item">
            <span class="info-label">–î–æ—Å—Ç—É–ø–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å:</span>
            <span class="info-value">${station.availablePower} –∫–í—Ç</span>
          </div>
          <div class="info-item">
            <span class="info-label">–ê–≤—Ç–æ–º–æ–±–∏–ª—å:</span>
            <span class="info-value">${station.carConnected ? 'üîå –ü–æ–¥–∫–ª—é—á–µ–Ω' : '‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ:</span>
            <span class="info-value">${station.chargingAllowed ? '‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–æ' : '‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ'}</span>
          </div>
        </div>
        
        <div class="power-bar">
          <div class="power-fill" style="width: ${powerPercent}%"></div>
        </div>
        
        <div style="font-size: 12px; color: #6b7280; text-align: center; margin-top: 5px;">
          –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ${powerPercent.toFixed(1)}%
        </div>
        
        ${station.hasError ? `<div class="error-message">‚ö†Ô∏è ${station.errorMessage}</div>` : ''}
        
        <div class="button-group" style="margin-top: 15px; justify-content: center;">
          <button class="btn" onclick="editStation(${station.id})">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
          <button class="btn btn-danger" onclick="deleteStation(${station.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;
      
      return card;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    function updateLastUpdate() {
      const now = new Date();
      document.getElementById('lastUpdate').textContent = 
        now.toLocaleTimeString('ru-RU');
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç–∞–Ω—Ü–∏–∏
    function addStation() {
      currentEditingId = null;
      document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–Ω—Ü–∏—é';
      document.getElementById('stationForm').reset();
      document.getElementById('stationModal').style.display = 'block';
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏
    function editStation(id) {
      const station = stations.find(s => s.id === id);
      if (!station) return;
      
      currentEditingId = id;
      document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞–Ω—Ü–∏—é';
      document.getElementById('displayName').value = station.displayName;
      document.getElementById('technicalName').value = station.technicalName;
      document.getElementById('stationType').value = station.type;
      document.getElementById('maxPower').value = station.maxPower;
      document.getElementById('stationModal').style.display = 'block';
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏
    async function deleteStation(id) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç–∞–Ω—Ü–∏—é?')) return;
      
      try {
        const response = await fetch(`/api/stations/${id}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          loadStations(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        } else {
          alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞–Ω—Ü–∏–∏');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞–Ω—Ü–∏–∏:', error);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞–Ω—Ü–∏–∏');
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Å—Ç–∞–Ω—Ü–∏–∏
    async function handleStationSubmit(event) {
      event.preventDefault();
      
      const formData = {
        displayName: document.getElementById('displayName').value,
        technicalName: document.getElementById('technicalName').value,
        type: document.getElementById('stationType').value,
        maxPower: parseFloat(document.getElementById('maxPower').value),
        status: 'available',
        currentPower: 0,
        availablePower: parseFloat(document.getElementById('maxPower').value),
        carConnected: false,
        chargingAllowed: true,
        hasError: false,
        errorMessage: '',
        masterId: document.getElementById('stationType').value === 'slave' ? 1 : 0,
        voltageL1: 230, voltageL2: 230, voltageL3: 230,
        currentL1: 0, currentL2: 0, currentL3: 0
      };
      
      try {
        const url = currentEditingId ? `/api/stations/${currentEditingId}` : '/api/stations';
        const method = currentEditingId ? 'PATCH' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        if (response.ok) {
          closeModal();
          loadStations(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        } else {
          alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞–Ω—Ü–∏–∏');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞–Ω—Ü–∏–∏:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞–Ω—Ü–∏–∏');
      }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeModal() {
      document.getElementById('stationModal').style.display = 'none';
      currentEditingId = null;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    function refreshData() {
      loadStations();
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
    function exportData() {
      const dataStr = JSON.stringify(stations, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `stations_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
    }

    // –ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
    function emergencyStop() {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–≤–∞—Ä–∏–π–Ω—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤—Å–µ—Ö —Å—Ç–∞–Ω—Ü–∏–π?')) {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ WebSocket
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            action: 'emergencyStop'
          }));
        }
        alert('–ö–æ–º–∞–Ω–¥–∞ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
      }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    window.onclick = function(event) {
      const modal = document.getElementById('stationModal');
      if (event.target === modal) {
        closeModal();
      }
    };
  </script>
</body>
</html>