# Makefile –¥–ª—è —Å–±–æ—Ä–∫–∏ C-—Å–µ—Ä–≤–µ—Ä–∞ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—Ä—è–¥–Ω—ã–º–∏ —Å—Ç–∞–Ω—Ü–∏—è–º–∏
# –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Nix –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -D_GNU_SOURCE
INCLUDES = -I.
LIBS = -lpthread

# –ò–º—è –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
TARGET = charging_station_server

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
SOURCES = main.c storage.c simple_http.c simple_json.c

# –û–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
OBJECTS = $(SOURCES:.c=.o)

# –†–µ–∂–∏–º—ã —Å–±–æ—Ä–∫–∏
DEBUG_CFLAGS = -g -O0 -DDEBUG
RELEASE_CFLAGS = -O2 -DNDEBUG

# –¶–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
all: debug

# –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
debug: CFLAGS += $(DEBUG_CFLAGS)
debug: $(TARGET)

# –†–µ–∂–∏–º –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
release: CFLAGS += $(RELEASE_CFLAGS)
release: $(TARGET)

# –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å —Å–±–æ—Ä–∫–∏
$(TARGET): $(OBJECTS)
	@echo "üîó –õ–∏–Ω–∫–æ–≤–∫–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞: $(TARGET)"
	$(CC) $(OBJECTS) -o $(TARGET) $(LIBS)
	@echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $(TARGET)"

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è –æ–±—ä–µ–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
%.o: %.c
	@echo "üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è: $<"
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# –û—á–∏—Å—Ç–∫–∞ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ –æ–±—ä–µ–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞"
	rm -f $(OBJECTS) $(TARGET)

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤–∫–ª—é—á–∞—è –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
distclean: clean
	@echo "üßπ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞"
	rm -f *~ *.bak core

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–¥–ª—è Ubuntu/Debian)
deps-ubuntu:
	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Ubuntu/Debian"
	sudo apt-get update
	sudo apt-get install -y build-essential

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–¥–ª—è CentOS/RHEL)
deps-centos:
	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è CentOS/RHEL"
	sudo yum groupinstall -y "Development Tools"

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
run: debug
	@echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
	./$(TARGET)

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –ø–æ—Ä—Ç–æ–º
run-port: debug
	@echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É $(PORT)"
	PORT=$(PORT) ./$(TARGET)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
check:
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"
	$(CC) $(CFLAGS) $(INCLUDES) -fsyntax-only $(SOURCES)

# –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ —Å –∏—Å—Ö–æ–¥–Ω—ã–º –∫–æ–¥–æ–º
archive:
	@echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞"
	tar -czf charging_station_server_$(shell date +%Y%m%d_%H%M%S).tar.gz *.c *.h Makefile README.md

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (—Ç—Ä–µ–±—É–µ—Ç clang-format)
format:
	@echo "üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞"
	clang-format -i -style="{BasedOnStyle: GNU, IndentWidth: 4, TabWidth: 4}" *.c *.h

# –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ (—Ç—Ä–µ–±—É–µ—Ç cppcheck)
analyze:
	@echo "üîç –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞"
	cppcheck --enable=all --inconclusive --std=c99 $(SOURCES)

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (—Ç—Ä–µ–±—É–µ—Ç doxygen)
docs:
	@echo "üìö –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
	doxygen Doxyfile

# –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
profile: CFLAGS += -pg
profile: $(TARGET)
	@echo "üìä –°–±–æ—Ä–∫–∞ —Å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏ (—Ç—Ä–µ–±—É–µ—Ç valgrind)
memcheck: debug
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏"
	valgrind --leak-check=full --show-leak-kinds=all ./$(TARGET)

# –ü–æ–º–æ—â—å
help:
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "  all          - –°–±–æ—Ä–∫–∞ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
	@echo "  debug        - –°–±–æ—Ä–∫–∞ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏"
	@echo "  release      - –°–±–æ—Ä–∫–∞ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞"
	@echo "  clean        - –û—á–∏—Å—Ç–∫–∞ –æ–±—ä–µ–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"
	@echo "  distclean    - –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞"
	@echo "  run          - –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞"
	@echo "  run-port     - –ó–∞–ø—É—Å–∫ –Ω–∞ –ø–æ—Ä—Ç—É PORT=xxxx"
	@echo "  check        - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞"
	@echo "  format       - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞"
	@echo "  analyze      - –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑"
	@echo "  memcheck     - –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏"
	@echo "  deps-ubuntu  - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Ubuntu"
	@echo "  deps-centos  - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π CentOS"
	@echo "  help         - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"

# –£–∫–∞–∑–∞–Ω–∏–µ, —á—Ç–æ —ç—Ç–∏ —Ü–µ–ª–∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è —Ñ–∞–π–ª–∞–º–∏
.PHONY: all debug release clean distclean run run-port check format analyze memcheck help deps-ubuntu deps-centos archive docs profile